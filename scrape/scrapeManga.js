var async = require('async');
var request = require('request');
var _ = require('lodash');
var bar = require('progress-bar').create(process.stdout);

var db = require('../models/db.js');
var Manga = db.Manga;

var fs = require('fs');
var errorLog = fs.WriteStream('./logs/scrapeManga-' + new Date().getTime() + '.log');

var getQ = async.queue(function(task, callback){
	request(task.url, function(err, res, body){
		if(err || res.statusCode === 404){
			console.log('404 at %s', task.url);
			console.log('\n');
			bar.update(task.index / 80931);
			console.log('\n');
			return callback();
		}

		mangaJSON = JSON.parse(body);

		var manga = new Manga({
			series_title_main: mangaJSON.name,
			series_title_english: mangaJSON.english[0],
			series_title_japanese: mangaJSON.japanese[0],
			series_title_synonyms: mangaJSON.synonyms,
			series_type: mangaJSON.kind.replace(/ /g, ''),
			series_date_start: mangaJSON.aired_on,
			series_date_end: mangaJSON.released_on,
			series_image_reference: 'http://shikimori.org' + mangaJSON.image.original,
			series_genres: _.pluck(mangaJSON.genres, 'name'),
			series_external_ids: {
				myanimelist: mangaJSON.myanimelist_id
			}
		});

		Manga.createOne(manga, function(err, doc){
			if(err){
				errorLog.write(err + '\n URL: ' + task.url + '\n\n');
				console.log('DB ERROR at %s', task.url);
				console.log('\n');
				bar.update(task.index / 80931);
				console.log('\n');
				return callback();
			}
			console.log('Added %s (%s)', manga.series_title_main, manga.series_type);
			console.log('\n');
			bar.update(task.index / 80931);
			console.log('\n');
			return callback();
		});
	});
}, 1);

var missedManga = [420,557,752,943,1345,1406,1508,1980,2013,2152,2950,2994,3074,3433,3434,3478,3707,3834,3864,3865,3884,3942,3946,3980,3988,4038,4177,4181,4197,4232,4238,4284,4566,4635,4658,4659,4757,4969,4974,5247,5249,5309,5355,5444,5450,5490,5568,5581,5654,5705,5710,5788,5846,5875,5931,5964,6003,6164,6248,6406,6853,6869,6919,7069,7127,7149,7201,7383,7533,7619,7668,7688,7728,7820,8054,8173,8241,8243,8419,8448,8496,8588,8637,8792,8854,8891,9056,9072,9115,9222,9305,9403,9705,9737,9977,10011,10013,10020,10055,10069,10110,10120,10153,10156,10268,10296,10312,10339,10410,10892,10901,10967,11010,11076,11176,11395,11402,11411,11438,11453,11496,11554,11597,11607,11688,11712,11748,11771,11795,11862,11903,11941,12028,12056,12068,12155,12174,12194,12203,12240,12251,12277,12298,12351,12373,12664,12665,12691,12693,12713,12741,12852,12854,12861,12872,12945,13015,13028,13068,13108,13158,13174,13186,13194,13204,13236,13238,13300,13348,13352,13495,13500,13679,13686,13710,13739,13768,13769,13872,14007,14042,14064,14311,14430,14464,14568,14595,14727,14831,14867,14961,14981,15053,15080,15143,15150,15162,15222,15275,15317,15475,15497,15524,15718,15808,15874,15933,16001,16065,16325,16468,16486,16501,16531,16532,16545,16578,16724,16770,16806,16816,16852,16887,16906,16929,17083,17124,17168,17289,17312,17382,17384,17417,17536,17640,17695,17753,17797,17824,17882,17922,18114,18228,18301,18361,18362,18371,18411,18496,18540,18652,18653,18684,18755,18784,18798,18926,19156,19357,19489,19566,19601,19833,19839,19885,19931,19955,19966,20065,20130,20245,20249,20358,20379,20389,20393,20467,20477,20550,20560,20577,20591,20595,20614,20649,20678,20680,20721,20760,20796,20806,20869,21019,21062,21075,21231,21241,21313,21370,21371,21443,21509,21544,21621,21646,21658,21700,21840,21855,21876,21958,21981,22018,22084,22123,22131,22173,22191,22204,22228,22324,22431,22455,22504,22545,22568,22627,22661,22699,22738,22739,22830,22909,23032,23067,23116,23152,23192,23256,23353,23382,23496,23550,23570,23571,23616,23636,23700,23800,23818,23836,23881,23942,23947,24037,24056,24057,24066,24089,24206,24238,24272,24412,24413,24428,24431,24439,24489,24561,24563,24600,24617,24633,24665,24671,24763,24834,24912,25057,25083,25097,25123,25191,25210,25229,25303,25314,25445,25525,25552,25597,25609,25690,25713,25826,25848,25859,25876,25952,26045,26103,26121,26162,26280,26303,26325,26386,26613,26642,26690,26698,26728,26742,26789,26819,26883,26927,26939,27217,27303,27329,27615,27633,27685,27719,27861,27877,27905,28035,28103,28125,28429,28573,28627,28839,28977,29141,29161,29293,29361,29401,29419,29447,29553,29627,29699,30051,30119,30291,30389,30393,30513,30595,30725,30741,30859,30935,31499,31511,31655,31757,31811,31817,31935,31983,32071,32101,32205,32297,32311,32425,32457,32523,32615,32665,32831,32899,33075,33251,33297,33337,33357,33523,33971,34269,34293,34553,34681,34831,34841,35117,35243,35281,35521,35555,35573,35665,35691,36073,36567,36595,36603,36661,36723,36873,36879,37419,37523,37783,37795,37947,37979,38195,38291,38333,38393,38397,38551,38581,38601,38605,38639,38673,38813,38851,38853,38859,39313,39395,39417,39651,39859,39905,40087,40093,40141,40167,40187,40275,40363,40409,40419,40491,40711,40753,40759,40955,40991,41021,41067,41113,41117,41209,41211,41311,41445,41501,41559,41575,41699,41763,41769,41775,41777,41787,41957,42127,42179,42221,42327,42353,42563,42695,42707,42867,43071,43161,43393,43509,43519,43611,43697,43819,43845,43885,44039,44167,44207,44361,44569,44697,44951,45023,45095,45123,45221,45261,45263,45363,45409,45525,45597,45605,45625,45641,45843,45970,46024,46166,46232,46258,46470,46476,46634,46876,46894,46936,47160,47196,47204,47665,47669,47763,47847,47861,47867,47957,47989,48271,48383,48399,48617,48721,48725,48727,48751,48773,48803,48899,48961,49189,49253,49331,49463,49543,49575,49611,49675,49881,49927,50145,50363,50523,50553,50625,50663,50845,51025,51047,51057,51191,51227,51233,51235,51309,51315,51355,51361,51453,51459,51461,51755,51815,51869,51969,52117,52147,52167,52215,52277,52431,52887,52895,52905,52915,52945,53007,53025,53227,53253,53329,53367,53565,53615,53675,53691,53737,53745,53805,53989,54083,54127,54241,54247,54593,54597,54723,54763,55053,55205,55377,55431,55621,55799,55821,55869,55957,56095,56227,56347,56385,56465,56469,56477,56483,56491,56501,56531,56763,56805,57033,57035,57171,57185,57239,57245,57269,57325,57433,57561,57571,57577,57617,57795,57805,57831,57849,57947,58145,58165,58233,58263,58281,58441,58563,58679,58685,58717,58777,58935,58951,59043,59267,59283,59401,59445,59463,59773,59781,59961,60027,60427,60487,60661,60723,60763,61035,61081,61221,61343,61427,61445,61801,61883,62103,62185,62193,62227,62523,62599,62769,62789,62887,63029,63111,63207,63223,63319,63375,63413,63443,63445,63525,63647,63737,63789,63793,63829,63839,64019,64091,64241,64301,64315,64481,64505,64531,64571,64579,64681,64907,64931,65095,65099,65153,65155,65217,65253,65289,65327,65353,65365,65649,65925,65973,66189,66341,66753,66775,66827,66831,66901,66909,66989,67617,67671,67677,67709,67821,67845,67879,67941,67979,68031,68101,68379,68463,68469,68485,68595,68625,68705,68775,68779,68927,68983,69059,69079,69121,69237,69407,69611,69615,69673,69691,69845,69941,69963,70061,70179,70189,70251,70261,70307,70311,70473,70537,70557,70597,70647,70709,70829,70919,71047,71057,71065,71115,71131,71211,71237,71253,71307,71441,71555,71715,71737,71829,71839,71911,72153,72357,72461,72505,72515,72535,72591,72651,72777,72989,73033,73265,73303,73451,73551,73569,73741,73775,73923,73941,73947,73993,74055,74057,74125,74129,74133,74147,74157,74173,74239,74287,74415,74547,74567,74699,74765,74797,74801,74837,74847,74971,75023,75089,75121,75265,75285,75333,75553,75603,75625,75637,75933,75939,75945,76127,76225,76239,76315,76341,76369,76439,76451,76527,76569,76643,76653,76951,76995,77011,77023,77101,77111,77189,77341,77359,77375,77579,77849,78067,78083,78337,78465,78497,78657,78987,79063,79141,79209,79353,79473,79553,79951,80055,80293,80385,80435,80439,80555,80633,80645,80795];

for (var i = 0, len = missedManga.length; i < len; i++) {
	getQ.push({
		url: 'http://shikimori.org/api/mangas/' + missedManga[i],
		index: missedManga[i]
	});
}